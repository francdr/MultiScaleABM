---
title: "MultiScaleABM"
output: github_document
---

MultiScaleABM is an R package that implements a stochastic age-stratified agent-based model (ABM) of infectious disease dynamics, with within-host viral load simulation. The framework is designed for flexibility and extensibility, making it suitable for modeling complex epidemiological processes including transmission heterogeneity, age structure, and mutation.

## ðŸš€ Features

* Stochastic agent-based model with age groups
* Within-host viral load simulation using a second-order stochastic differential equation
* Infection process based on viral load dynamics

## ðŸ“¦ Installation

You can install the package from source using the following command in R:

```r
# In the package root directory
devtools::install()
```

Make sure you have a working C++ toolchain (Rtools on Windows, Xcode on Mac, build-essential on Linux).

## ðŸ§ª Usage Example

```r
# ------------------------------------------------------------------------------
# Load contact matrix and age distribution from CSV files
# ------------------------------------------------------------------------------

contact_matrix   <- as.matrix(read.csv("data/contact_matrix.csv",    header = FALSE))
age_distribution <- as.numeric(read.csv("data/age_distribution.csv", header = FALSE)[, 2])

# ------------------------------------------------------------------------------
# Set Parameters
# ------------------------------------------------------------------------------

params <- list(
  # ABM parameters
  n_agents = 1e5,
  n_days = 180,
  contact_matrix = contact_matrix,
  age_groups = age_distribution,
  # Viral load parameters
  k = rep(0.06, length(age_distribution)),
  gamma = rep(0.3, length(age_distribution)),
  sigma = rep(0.2, length(age_distribution)),
  beta = 1.8e-5,
  dt = 0.05,
  VL_days = 20,
  V0 = log(0.06),
  dV0 = 5,
  # Simulation parameters
  n_initial_infected = 10,
  recovery_threshold = 20,#0.01,
  parallel = TRUE,
  n_threads = 12,
  verbose = T
)

out <- run_abm(params)
plot(out$daily_infected, type = "l", col = "red", main = "Daily Infected", ylab = "Count")
```

## ðŸ“ˆ Viral Load Simulation

The viral load dynamics are modelled with a stochastic second-order differential equation. It uses the Eulerâ€“Maruyama method, a numerical technique for solving stochastic differential equations (SDEs), to generate smooth and biologically plausible viral load trajectories.

### ðŸ§  Model Overview

The viral load trajectory is governed by:

$$
\frac{d^2V}{dt^2} = -kV - \gamma \frac{dV}{dt} + \sigma \eta(t)
$$

Where:

* $V(t)$: log viral load (latent signal)
* $k$: stiffness (restoring force)
* $\gamma$: damping coefficient
* $\sigma$: noise amplitude
* $\eta(t)$: Gaussian white noise

This is discretized using Eulerâ€“Maruyama:

$$
\begin{align*}
\text{dV}[t+1] &= \text{dV}[t] + (-k \cdot V[t] - \gamma \cdot \text{dV}[t]) \cdot dt \\
V[t+1] &= V[t] + \text{dV}[t] \cdot dt + \sigma \cdot \sqrt{dt} \cdot \mathcal{N}(0,1)
\end{align*}
$$

### ðŸ”§ Parameters

| Name    | Description            |
| ------- | ---------------------- |
| `days`  | Number of time steps   |
| `dt`    | Time step size         |
| `V0`    | Initial log-viral load |
| `dV0`   | Initial rate of change |
| `k`     | Stiffness              |
| `gamma` | Damping coefficient    |
| `sigma` | Noise amplitude        |

### ðŸ§ª Output

A  vector of viral load over time â€” suitable for use in transmission models.

## ðŸ“Š Plotting Viral Load Trajectories

You can visualize the viral load trajectory for a single individual using the plot_viral_load_trajectory() function. This function samples a random age group (unless specified) and plots the normalized viral load curve generated by the underlying stochastic model.

Example
```r
plot_viral_load_trajectory(params = params)
```
This provides a quick way to visually inspect the output of the stochastic viral load model. To visualize stochastic variability, you can generate a spaghetti plot with N viral load trajectories:

```r
plot_viral_load_trajectory(params = params, spaghetti = TRUE, N = 50)
```


